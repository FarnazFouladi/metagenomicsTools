rm(list=ls())
library("gap")

numSimulations <- 10000
numReadsPerSimulation <- 100000

pValues <- vector();
numberFound<- vector();
variance <- vector();
expectedNumberFound <- vector();
ratio <- vector()

for( i in 1:numSimulations)
{
	rateOfGeneExperession <- runif(1) / 100;  # no gene is more than 1%
	expectedMean <- rateOfGeneExperession  * numReadsPerSimulation 
	
	#null hypothesis always true under Poisson distribution
	var = expectedMean
	
	numFound<- rnorm( 1,mean=expectedMean  , sd = sqrt(var))
	
	if( numFound < 0 ) 
		numFound =0;
		
	numFound = numFound + 1
	
	numFound= round(numFound)
	numberFound[i] = numFound
	
	expectedNumberFound[i] <- expectedMean
	
	ratio[i] = expectedMean/numFound
	
	if( ratio[i] < 1 ) 
		ratio[i] = - ratio[i]
	
	variance[i] <- var

	pValues[i] <- 
		poisson.test( numFound, numReadsPerSimulation, rateOfGeneExperession,alternative="two.sided")$p.value	
	
	par( mfrow = c( 2, 2 ) )

	titleStr <- paste("Number of simulated genes = ",i,sep="")

	# load package gap first
	colors = ifelse( pValues <0.05 , "red", "black" )
	plot(numberFound-expectedNumberFound , -log10(pValues),main=titleStr, col=colors)
	plot(numberFound-expectedNumberFound, ratio, col=colors )
	qqunif(pValues,logscale=FALSE,)
	hist(pValues,plot=TRUE,breaks=10)
	Sys.sleep(.1)
	
}