rm(list=ls())

setwd("C:\\EmilyJan2018\\spreadsheets")

filepath <- "pcoa_withMetadatagenus.txt";

myT <-read.table(filepath,sep="\t",header=TRUE)
numCols <- ncol(myT)
myColClasses <- c(rep("character", 50), rep("numeric", numCols-50))
myT <-read.table(filepath,sep="\t", colClasses=myColClasses,header=TRUE)

myT <- myT[ myT$readNum == 1, ]

# mouse only
myT <- myT[ myT$Mouse.group != "n.a.", ]

# first question - are there any differences between T1 and T2
# model is y = T1/T2 + week + donor
myTCaseOnly <- myT[ myT$Mouse.group != "HC", ]
pValuesGroup <- vector()
pValuesTime <- vector()
names <- vector()
backIndex <- vector()

index <-1
for( i in 51:471) 
{
	bug <- myTCaseOnly[,i]
	
	if( sum( bug != 0) > nrow(	myTCaseOnly ) / 4)
	{
		aLm <- lm( bug ~ myTCaseOnly$Mouse.group + as.numeric(myTCaseOnly$Week)+ myTCaseOnly$donorID)
		pValuesGroup[index] <- unclass(summary(aLm))$coefficients[2,4]
		pValuesTime[index] <- unclass(summary(aLm))$coefficients[3,4]
		names[index] <- names(myTCaseOnly)[i]
		backIndex[index] <- i
		index <- index + 1
	}
}

resultsFrame <- data.frame(names,pValuesTime,pValuesGroup, backIndex)

resultsFrame <- resultsFrame [order(resultsFrame$pValuesGroup),]
resultsFrame$adjustedPGroup <- p.adjust( resultsFrame$pValuesGroup, method = "BH" )	
resultsFrame$adjustedPTime<- p.adjust( resultsFrame$pValuesTime, method = "BH" )	

write.table(resultsFrame, file=paste("pValues_T1_T2.txt",sep=""), sep="\t",row.names=FALSE)

pdf("boxplots.pdf")

for ( i in 1:nrow(resultsFrame))
{
	aTitle <-paste(resultsFrame$names[i], "p group=",format(resultsFrame$adjustedPGroup[i],digits=3) )
	boxplot( myTCaseOnly[, resultsFrame$backIndex[i]] ~  myTCaseOnly$Mouse.group,main=aTitle )
}

dev.off()