rm(list=ls())

setwd("C:\\EmilyJan2018\\spreadsheets")

# manually replace "n.a" with NA
filepath <- "pcoa_withMetadatagenusWithNA.txt";

myT <-read.table(filepath,sep="\t",header=TRUE)
numCols <- ncol(myT)
myColClasses <- c(rep("character", 20),
				  rep("numeric", 2), 
				  rep("character", 2),
				  rep("numeric", 17),
				  rep("character", 9),
	   rep("numeric", numCols-50))
myT <-read.table(filepath,sep="\t", colClasses=myColClasses,header=TRUE)

myT <- myT[ myT$readNum == 1, ]

# mouse only
myT <- myT[ !is.na (myT$Mouse.group), ]

myTHuman <-read.table(filepath,sep="\t", colClasses=myColClasses,header=TRUE)
myTHuman <- myTHuman[ myTHuman$readNum == 1, ]
myTHuman <-myTHuman[  !is.na (myT$Mouse.group), ]


donorString <- vector()
caseControl <- vector()

for( i in 1:nrow(myT))
{
	if( myT$Mouse.group[i] == "T1" || myT$Mouse.group[i] == "T2" ) 
	{
		 donorString[i] = paste0(myT$donorID[i], "_case")
		 caseControl[i] = "case"
	}
	else if(myT$Mouse.group[i] == "HC"  )
	{
		 donorString[i] = paste0(myT$donorID[i], "_control")
		 caseControl[i] = "control"
	}
	else
	{
		stop("no")
	}
}

donorStringHuman <- vector()

for( i in 1:nrow(myTHuman))
{
	twoChars = substr(myTHuman$Sample.ID[i],1,2)
	if( twoChars == "T1" || twoChars == "T2" ) 
	{
		 donorStringHuman[i] = paste0(myTHuman$donorID[i], "_case")
	}
	else if(twoChars == "HC"  )
	{
		 donorStringHuman[i] = paste0(myTHuman$donorID[i], "_control")
	}
	else
	{
		donorStringHuman[i] = "NA"
	}
}




# any difference between case and control
# model will be bug = week + case/control + donorID
# we'll start by ignoring T1/T2..

pValuesCaseControl <- vector()
pValuesTime <- vector()
names <- vector()
backIndex <- vector()

index <-1
todo <-c(21,22,25:41,51:471)
for( i in todo) 
{
	toUse <- !is.na(myT[,i])
	bug <- myT[toUse,i]
	
	if( sum( bug != 0) > nrow(	myT) / 10)
	{
		aLm <- lm( bug ~ caseControl[toUse] + as.numeric(myT$Week[toUse]) + donorString[toUse])
		pValuesCaseControl[index] <- unclass(summary(aLm))$coefficients[2,4]
		pValuesTime[index] <- unclass(summary(aLm))$coefficients[3,4]
		names[index] <- names(myT)[i]
		backIndex[index] <- i
		index <- index + 1
	}
}

resultsFrame <- data.frame(names,pValuesTime,pValuesCaseControl, backIndex)

resultsFrame <- resultsFrame [order(resultsFrame$pValuesCaseControl),]
resultsFrame$adjustedpValuesCaseControl<- p.adjust( resultsFrame$pValuesCaseControl, method = "BH" )	
resultsFrame$adjustedPTime<- p.adjust( resultsFrame$pValuesTime, method = "BH" )	

write.table(resultsFrame, file=paste("pValues_caseControl.txt",sep=""), sep="\t",row.names=FALSE)

pdf("caseControl.pdf")
par(mfrow=c(3,2))

donors <- unique(myT$donorID)

for ( i in 1:nrow(resultsFrame))
{
	aTitle <-paste(resultsFrame$names[i], "p case/control=",
		format(resultsFrame$adjustedpValuesCaseControl[i],digits=3) )
	
	boxplot( myT[, resultsFrame$backIndex[i]] ~  donorString,main=aTitle ,las=2)
	
	aMin = min(myT[ , resultsFrame$backIndex[i]])
	aMax = max(myT[ , resultsFrame$backIndex[i]])
	aRange = c(aMin,aMax)
	
	for( d in donors ) 
	{
		plot( 
			as.numeric(myT$Week[ myT$donorID ==d & caseControl =="case" ])
			, myT[ myT$donorID == d & caseControl =="case"  , resultsFrame$backIndex[i]], col = "red", main=d ,
			xlab="weeks", ylab=resultsFrame$names[i], ylim=aRange)
			
			
		points( 
			as.numeric(myT$Week[ myT$donorID ==d & caseControl =="control" ])
			, myT[ myT$donorID == d & caseControl =="control"  , resultsFrame$backIndex[i]], col = "black", main=d ,
			xlab="weeks", ylab=resultsFrame$names[i] )
	}
	
	lookup = names(myTHuman)==resultsFrame$names[i]
	
	boxplot( myTHuman[,lookup] ~ donorStringHuman,las=2,main=paste("human",resultsFrame$names[i]),
							ylab = resultsFrame$names[i])
	
	hBug <-  myTHuman[,lookup] 
	someFrame <- data.frame( hBug, donorStringHuman)
	
	stripchart(hBug ~ donorStringHuman, 
			data = someFrame,vertical = TRUE, pch = 21, add=TRUE )	
			
	plot(0,type='n',axes=FALSE,ann=FALSE)
		
			
}

dev.off()