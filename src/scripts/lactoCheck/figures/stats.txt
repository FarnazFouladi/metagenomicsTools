rm(list=ls())

rm(list=ls())
	
setwd("C:\\lactoCheck\\rdp")

myT <- read.table("genusasColumnsNormWithMetadata.txt", sep="\t", header=TRUE)
myT <- myT[ myT$stoolOrGa != "S" & myT$run == "Run1" & myT$read=="R1",]
myWithNeg <- myT 
myT <- myT[1:29,] # remove negative control

myLm <- lm( myT$qPCR16S ~ myT$birthMode + myT$groupNumber )
anova(myLm)

pValuesBirthMode <- vector()
pValuesGroup <- vector()
names <- vector()
tableIndex <- vector()

index <- 1
for( i in 11:ncol(myT))
	if(  (sum(myT[,i] ==0) / nrow(myT)) < .25 )
	{
		bug <- myT[,i]
		myLm <- lm( bug~ myT$birthMode + myT$groupNumber )
		pValuesBirthMode[index] <- anova(myLm)$"Pr(>F)"[1]
		pValuesGroup[index] <-  anova(myLm)$"Pr(>F)"[2]
		names[index] <- names(myT)[i]
		tableIndex[index] <- i
		index <- index + 1
	}
	
dFrame <- data.frame( names, pValuesBirthMode,pValuesGroup, tableIndex)
dFrame <- dFrame [order(dFrame$pValuesBirthMode),]
dFrame$pValuesBirthModeAdjusted<- p.adjust( dFrame$pValuesBirthMode, method = "BH" )	
dFrame$pValuesGroupAdjusted<- p.adjust( dFrame$pValuesGroup, method = "BH" )	

write.table(dFrame, file=paste("pValuesForModeTimeGenus.txt",sep=""), sep="\t",row.names=FALSE)


colors <- vector()

for( i in 1:nrow(myWithNeg))
{
	if( myWithNeg$groupNumber[i] == 0) 
	{
		colors[i] = "blue"			
	}
	else
	{
		if( myWithNeg$birthMode[i] == "C" )
			colors[i] = "red"
		else
			colors[i] = "black"
	}
}
	


pdf("boxplotsGenus.pdf")
par(mfrow=c(1,2))

for ( i in 1:nrow(dFrame))
{
	index <- dFrame$tableIndex[i]
	bug <- myWithNeg[,index]
	birthMode <- myWithNeg$birthMode
	groupNumber <- myWithNeg$groupNumber
	myFrame <- data.frame(bug,birthMode,groupNumber)
	
	plot(bug ~ groupNumber, main = names(myWithNeg)[index],cex=2.5,pch=16, col=colors,xlab="group", ylab ="relative abundance")
	#legend("topleft",c("negative control", "cesarean","vaginal"),pch=16, col=c("blue", "red", "black"),cex=1.3)
	

	boxplot(bug ~ birthMode, main = names(myWithNeg)[index])

	stripchart(bug ~ birthMode, data = myFrame,vertical = TRUE, pch = 16,cex=1.25 ,add=TRUE ,col=colors)		
	
}

dev.off()
