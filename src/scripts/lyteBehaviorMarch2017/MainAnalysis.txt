
rm(list=ls())

setwd("C:\\LyteBehaviorMarch2017\\rg_results\\")
library("Kendall")

myT <- read.table("LyteSharon_r01_crDataOnlyTaxaAsColumnsLogNormPlusMetadata.txt", sep="\t", header=TRUE)

tissues <- unique(myT$Source)

for( t in tissues ) 
{
	subT <- myT[ myT$Source == t, ]
	index <- 1
	names <- vector()
	pValuesGroup <- vector()
	pValuesSex <- vector()
	pdf( paste("main_", t,".pdf", sep=""))
	
	for ( j in c(2,3,61:3560))
	{
		par(mfrow=c(2,1))
		bug <- subT[,j]
		
		if( sum(bug != 0 ) > nrow(subT) / 4 )
		{
			pValuesGroup[index] <- wilcox.test( subT[subT$Group=="Experimental", j],  
										subT[subT$Group=="Control", j])$p.value
			names[index] <- names(subT)[j]
			
			
			group <- factor(subT$Group)
			boxplot( bug ~ group ,
			main = paste( names[index], format(pValuesGroup[index],digits=3) ) )	
			
			myFrame <- data.frame(bug, group)
			
			stripchart(bug ~ group , 
				data = myFrame,vertical = TRUE, pch = 21, add=TRUE, ylab = names[index])	
			
			sex <- factor(subT$Sex);
			
			pValuesSex[index] <- wilcox.test( subT[subT$Sex=="male", j],  
										subT[subT$Sex=="female", j])$p.value
		
			boxplot( bug ~ sex,
			main = paste( names[index], format(pValuesSex[index],digits=3) ) )	
			
			myFrame <- data.frame(bug, sex)
			
			stripchart(bug ~ sex, 
				data = myFrame,vertical = TRUE, pch = 21, add=TRUE, ylab = names[index])	
			
				
			index <- index + 1
		}
		
		hist(pValuesGroup,breaks=20)
		hist(pValuesSex,breaks=20)
	}
	
	myFrame <- data.frame(names,pValuesGroup,pValuesSex)
	myFrame <- myFrame [order(myFrame$pValuesGroup),]
	myFrame$adjustedPValuesGroup <- p.adjust( myFrame$pValuesGroup, method = "BH" )	
	myFrame$adjustedPValuesSex<- p.adjust( myFrame$pValuesSex, method = "BH" )
	write.table(myFrame, file=paste("mainEffects", t, ".txt",sep=""), sep="\t",row.names=FALSE)
	dev.off()	
}
